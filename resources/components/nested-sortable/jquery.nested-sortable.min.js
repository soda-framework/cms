(function(e){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","jquery-ui/sortable"],e)}else{e(window.jQuery)}})(function(e){"use strict";function t(e,t,s){return e>t&&e<t+s}e.widget("qccf.nestedSortable",e.extend({},e.ui.sortable.prototype,{options:{disableParentChange:false,doNotClear:false,expandOnHover:700,isAllowed:function(){return true},isTree:false,listType:"ol",maxLevels:0,protectRoot:false,rootID:null,rtl:false,startCollapsed:false,tabSize:20,excludeRoot:false,left:"lft",right:"rght",attribute:"id",branchClass:"nested-sortable-branch",collapsedClass:"nested-sortable-collapsed",disableNestingClass:"nested-sortable-no-nesting",errorClass:"nested-sortable-error",expandedClass:"nested-sortable-expanded",hoveringClass:"nested-sortable-hovering",leafClass:"nested-sortable-leaf",disabledClass:"nested-sortable-disabled"},_create:function(){var t=this;var s;this.element.data("ui-sortable",this.element.data("qccf.nestedSortable"));if(!this.element.is(this.options.listType)){s="NestedSortable: Please check that the listType option is set to your actual list type.";throw new Error(s)}if(this.options.isTree&&this.options.expandOnHover){this.options.tolerance="intersect"}e.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){e(this.items).each(function(){var e=this.item;var s=e.hasClass(t.options.collapsedClass);var i=e.hasClass(t.options.expandedClass);if(e.children(t.options.listType).length){e.addClass(t.options.branchClass);if(!s&&!i){if(t.options.startCollapsed){e.addClass(t.options.collapsedClass)}else{e.addClass(t.options.expandedClass)}}}else{e.addClass(t.options.leafClass)}})}},_destroy:function(){this.element.removeData("qccf.nestedSortable").removeData("ui-sortable");return e.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(t){var s;var i;var l;var o;var r=this;var n=this.options;var a=false;var h=e(document);var d;var p;var c;var f;var u;var v;var m;var g;var C;var b;var y;var _;this.position=this._generatePosition(t);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){if(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<n.scrollSensitivity){a=this.scrollParent.scrollTop()+n.scrollSpeed;this.scrollParent.scrollTop(a)}else if(t.pageY-this.overflowOffset.top<n.scrollSensitivity){a=this.scrollParent.scrollTop()-n.scrollSpeed;this.scrollParent.scrollTop(a)}if(this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<n.scrollSensitivity){a=this.scrollParent.scrollLeft()+n.scrollSpeed;this.scrollParent.scrollLeft(a)}else if(t.pageX-this.overflowOffset.left<n.scrollSensitivity){a=this.scrollParent.scrollLeft()-n.scrollSpeed;this.scrollParent.scrollLeft(a)}}else{if(t.pageY-h.scrollTop()<n.scrollSensitivity){a=h.scrollTop()-n.scrollSpeed;h.scrollTop(a)}else if(e(window).height()-(t.pageY-h.scrollTop())<n.scrollSensitivity){a=h.scrollTop()+n.scrollSpeed;h.scrollTop(a)}if(t.pageX-h.scrollLeft()<n.scrollSensitivity){a=h.scrollLeft()-n.scrollSpeed;h.scrollLeft(a)}else if(e(window).width()-(t.pageX-h.scrollLeft())<n.scrollSensitivity){a=h.scrollLeft()+n.scrollSpeed;h.scrollLeft(a)}}if(a!==false&&e.ui.ddmanager&&!n.dropBehaviour){e.ui.ddmanager.prepareOffsets(this,t)}}this.positionAbs=this._convertPositionTo("absolute");d=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px"}this.hovering=this.hovering?this.hovering:null;this.mouseentered=this.mouseentered?this.mouseentered:false;(function(){var e=this.placeholder.parent().parent();if(e&&e.closest(".ui-sortable").length){p=e}}).call(this);c=this._getLevel(this.placeholder);f=this._getChildLevels(this.helper);m=document.createElement(n.listType);for(s=this.items.length-1;s>=0;s--){i=this.items[s];l=i.item[0];o=this._intersectsWithPointer(i);if(!o){continue}if(i.instance!==this.currentContainer){continue}if(l.className.indexOf(n.disabledClass)!==-1){if(o===2){u=this.items[s+1];if(u&&u.item.hasClass(n.disabledClass)){continue}}else if(o===1){v=this.items[s-1];if(v&&v.item.hasClass(n.disabledClass)){continue}}}g=o===1?"next":"prev";if(l!==this.currentItem[0]&&this.placeholder[g]()[0]!==l&&!e.contains(this.placeholder[0],l)&&(this.options.type==="semi-dynamic"?!e.contains(this.element[0],l):true)){if(!this.mouseentered){e(l).mouseenter();this.mouseentered=true}if(n.isTree&&e(l).hasClass(n.collapsedClass)&&n.expandOnHover){if(!this.hovering){e(l).addClass(n.hoveringClass);this.hovering=window.setTimeout(function(){e(l).removeClass(n.collapsedClass).addClass(n.expandedClass);r.refreshPositions();r._trigger("expand",t,r._uiHash())},n.expandOnHover)}}this.direction=o===1?"down":"up";if(this.options.tolerance==="pointer"||this._intersectsWithSides(i)){e(l).mouseleave();this.mouseentered=false;e(l).removeClass(n.hoveringClass);if(this.hovering){window.clearTimeout(this.hovering)}this.hovering=null;if(n.protectRoot&&!(this.currentItem[0].parentNode===this.element[0]&&l.parentNode!==this.element[0])){if(this.currentItem[0].parentNode!==this.element[0]&&l.parentNode===this.element[0]){if(!e(l).children(n.listType).length){l.appendChild(m);if(n.isTree){e(l).removeClass(n.leafClass).addClass(n.branchClass+" "+n.expandedClass)}}if(this.direction==="down"){C=e(l).prev().children(n.listType)}else{C=e(l).children(n.listType)}if(C[0]!==undefined){this._rearrange(t,null,C)}}else{this._rearrange(t,i)}}else if(!n.protectRoot){this._rearrange(t,i)}}else{break}this._clearEmpty(l);this._trigger("change",t,this._uiHash());break}}(function(){var e=this.placeholder.prev();if(e.length){b=e}else{b=null}}).call(this);if(b!==null&&b!==undefined){while(b[0].nodeName.toLowerCase()!=="li"||b[0].className.indexOf(n.disabledClass)!==-1||b[0]===this.currentItem[0]||b[0]===this.helper[0]){if(b[0].previousSibling){b=e(b[0].previousSibling)}else{b=null;break}}}(function(){var e=this.placeholder.next();if(e.length){y=e}else{y=null}}).call(this);if(y!==null&&y!==undefined){while(y[0].nodeName.toLowerCase()!=="li"||y[0].className.indexOf(n.disabledClass)!==-1||y[0]===this.currentItem[0]||y[0]===this.helper[0]){if(y[0].nextSibling){y=e(y[0].nextSibling)}else{y=null;break}}}this.beyondMaxLevels=0;if(p!==null&&p!==undefined&&(y===null||y===undefined)&&!(n.protectRoot&&p[0].parentNode==this.element[0])&&(n.rtl&&this.positionAbs.left+this.helper.outerWidth()>p.offset().left+p.outerWidth()||!n.rtl&&this.positionAbs.left<p.offset().left)){p.after(this.placeholder[0]);_=!p.children(n.listItem).children("li:visible:not(.ui-sortable-helper)").length;if(n.isTree&&_){p.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass)}if(typeof p!=="undefined")this._clearEmpty(p[0]);this._trigger("change",t,this._uiHash())}else if(b!==null&&b!==undefined&&!b.hasClass(n.disableNestingClass)&&(b.children(n.listType).length&&b.children(n.listType).is(":visible")||!b.children(n.listType).length)&&!(n.protectRoot&&this.currentItem[0].parentNode===this.element[0])&&(n.rtl&&this.positionAbs.left+this.helper.outerWidth()<b.offset().left+b.outerWidth()-n.tabSize||!n.rtl&&this.positionAbs.left>b.offset().left+n.tabSize)){this._isAllowed(b,c,c+f+1);if(!b.children(n.listType).length){b[0].appendChild(m);if(n.isTree){b.removeClass(n.leafClass).addClass(n.branchClass+" "+n.expandedClass)}}if(d&&d<=b.offset().top){b.children(n.listType).prepend(this.placeholder)}else{b.children(n.listType)[0].appendChild(this.placeholder[0])}if(typeof p!=="undefined")this._clearEmpty(p[0]);this._trigger("change",t,this._uiHash())}else{this._isAllowed(p,c,c+f)}this._contactContainers(t);if(e.ui.ddmanager){e.ui.ddmanager.drag(this,t)}this._trigger("sort",t,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(t){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){e(this.domPosition.prev).after(this.placeholder)}else{e(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",t,this._uiHash())}e("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass);this.mouseentered=false;if(this.hovering){window.clearTimeout(this.hovering)}this.hovering=null;this._relocate_event=t;this._pid_current=e(this.domPosition.parent).parent().attr("id");this._sort_current=this.domPosition.prev?e(this.domPosition.prev).next().index():0;e.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(e){var s=this.options.isTree?.8:.5,i=t(this.positionAbs.top+this.offset.click.top,e.top+e.height*s,e.height),l=t(this.positionAbs.top+this.offset.click.top,e.top-e.height*s,e.height),o=t(this.positionAbs.left+this.offset.click.left,e.left+e.width/2,e.width),r=this._getDragVerticalDirection(),n=this._getDragHorizontalDirection();if(this.floating&&n){return n==="right"&&o||n==="left"&&!o}else{return r&&(r==="down"&&i||r==="up"&&l)}},_contactContainers:function(){if(this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]){return}e.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var t;var s;e.ui.sortable.prototype._clear.apply(this,arguments);if(!(this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index())){this._trigger("relocate",this._relocate_event,this._uiHash())}for(t=this.items.length-1;t>=0;t--){s=this.items[t].item[0];this._clearEmpty(s)}},toArray:function(t){var s=e.extend({},this.options,t);var i=s.startDepthCount||0;var l=[];var o=1;if(!s.excludeRoot){var r={item_id:s.rootID,parent_id:null,depth:i};r[s.left]=o;r[s.right]=(e(s.items,this.element).length+1)*2;l.push(r);o++}e(this.element).children(s.items).each(function(){o=n(this,i,o)});l=l.sort(function(e,t){return e.left-t.left});return l;function n(t,o,r){var a=r+1;var h;var d;var p;if(e(t).children(s.listType).children(s.items).length>0){o++;e(t).children(s.listType).children(s.items).each(function(){a=n(e(this),o,a)});o--}h=e(t).data(s.attribute);if(o===i){d=s.rootID}else{p=e(t).parent(s.listType).parent(s.items).data(s.attribute);d=p}if(h){var c=e(t).children("div").data();var f=e.extend(c,{id:h,parent_id:d,depth:o});f[s.left]=r;f[s.right]=a;l.push(f)}r=a+1;return r}},_clearEmpty:function(t){function s(t,s,i,l){if(l){s=[i,i=s][0]}e(t).removeClass(s).addClass(i)}var i=this.options;var l=e(t).children(i.listType);var o=l.has("li").length;var r=i.doNotClear||o||i.protectRoot&&e(t)[0]===this.element[0];if(i.isTree){s(t,i.branchClass,i.leafClass,r)}if(!r){l.parent().removeClass(i.expandedClass);l.remove()}},_getLevel:function(e){var t=1;var s;if(this.options.listType){s=e.closest(this.options.listType);while(s&&s.length>0&&!s.is(".ui-sortable")){t++;s=s.parent().closest(this.options.listType)}}return t},_getChildLevels:function(t,s){var i=this;var l=this.options;var o=0;s=s||0;e(t).children(l.listType).children(l.items).each(function(e,t){o=Math.max(i._getChildLevels(t,s+1),o)});return s?o+1:o},_isAllowed:function(e,t,s){var i=this.options,l=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),o=this.currentItem.parent().parent(),r=i.disableParentChange&&(typeof e!=="undefined"&&!o.is(e)||typeof e==="undefined"&&o.is("li"));if(r||!i.isAllowed(this.placeholder,e,this.currentItem)){this.placeholder.addClass(i.errorClass);if(l<s&&l!==0){this.beyondMaxLevels=s-l}else{this.beyondMaxLevels=1}}else{if(l<s&&l!==0){this.placeholder.addClass(i.errorClass);this.beyondMaxLevels=s-l}else{this.placeholder.removeClass(i.errorClass);this.beyondMaxLevels=0}}}}));e.qccf.nestedSortable.prototype.options=e.extend({},e.ui.sortable.prototype.options,e.qccf.nestedSortable.prototype.options)});
